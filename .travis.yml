language: cpp
matrix:
  include:
  - os: linux
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - g++-5
          - cmake
    env:
      - ARCH=x86_64
      - TOOLSET=linux-gnu
  - os: osx
    osx_image: xcode6.4
    addons:
      apt:
        sources:
          - llvm-toolchain-precise-3.7
        packages:
          - cmake
          - clang-3.7
    env:
      - ARCH=x86_64
      - TOOLSET=apple-darwin
before_install:
  - if [ $TRAVIS_OS_NAME == linux ]; then sudo apt-get install xorg-dev libgl1-mesa-glx libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev mesa-common-dev mesa-common-dev -y; fi
before_script:
  - curl -k -o next_git_tag.sh https://gist.githubusercontent.com/matusnovak/eba81343f5578c38cf0a9bc22b548727/raw/1678041e118a77c3083216cbf55bcf7b46e02e38/next_git_tag.sh
  - chmod +x ./next_git_tag.sh
  - git submodule init
  - git submodule update
script:
  - export CURRENT_BRANCH=$TRAVIS_BRANCH
  - if [ $TRAVIS_OS_NAME == linux ]; then sudo unlink /usr/bin/gcc && sudo ln -s /usr/bin/gcc-5 /usr/bin/gcc; fi
  - if [ $TRAVIS_OS_NAME == linux ]; then sudo unlink /usr/bin/g++ && sudo ln -s /usr/bin/g++-5 /usr/bin/g++; fi
  - gcc --version
  - g++ --version
  - mkdir build
  - cd build && (cmake ..  -DCMAKE_INSTALL_PREFIX=../install -DCMAKE_BUILD_TYPE=MinSizeRel || travis_terminate 1) && cd ..
  - cd build && (make install || travis_terminate 1) && cd ..
  - cd build && (ctest --verbose -C MinSizeRel -E "test_gl" || travis_terminate 1) && cd ..
  - export GCC_MACHINE=$(gcc -dumpmachine)
  - export GCC_VERSION=$(gcc -dumpversion)
  - cd install && zip -r "../finegraphics-$GCC_MACHINE-$GCC_VERSION.zip" * && cd ..
branches:
  only:
  - master
  - devel
notifications:
  email:
    recipients:
    - matusnov@gmail.com
  on_success: always
  on_failure: always
before_deploy:
  - pwd
  - ls
  - source ./next_git_tag.sh
  - echo "Exporting TRAVIS_TAG $GITHUB_RELEASE_TAG"
  - export TRAVIS_TAG=$GITHUB_RELEASE_TAG
deploy:
  provider: releases
  overwrite: true
  skip_cleanup: true
  target_commitish: $TRAVIS_COMMIT
  tag_name: $TRAVIS_TAG
  name: "Compiled - $TRAVIS_TAG"
  body: "$TRAVIS_COMMIT_MESSAGE"
  draft: false
  file_glob: true
  api_key:
    secure: axWbsQHE2zeFyt7EcLRyS5qpWUji1te4oqQMJv2iNqExg8JzhdofYLF6KMzaEKMk5Izo4wa7GrynzdCZ+dv9xG9NaJZHYthobVqG9fze6PYYcZadWbk3kAZeCvDUAB/d0/3Yx6VVFtm3EzprmbXiE6Yh6T5tMbNl5qGiHrYnrrfLMpoA7wnMTdR1/U7FjVjVSUBnFgAN5ORXZgsf3oCLaCb9S/AqD9b5xSktsDH8CnpB6yZKoESARUsK9Y9tsQOE4ADgV9C28oOeA/MDm4dIz/PJIeRQeSArEGbzPBYIsFaRMYiqr6mNJoNUtsSH6n3qcwazhFzKr6hNSxrmBC3HLohvVZ8/AOgw6IWcMPNPhwHwaA5hFF8dk9oCUtEL0YnacBx98MZV+UwePmfOyx5XqQbzCQYtQl1Et3WyEoFEwm1u1LCEylai7tuNl8Zb4gaBN5j/oLOrl5sM0UE7tgNFXNTj07lGixqQFjSEsjaNhPTBJxV9TfWWclc7O7zSU7yq7+Jym1zaDCdSC1p0UpsWzg59KG6vrtXj1p7AH9+cYE0zKI1L/smJM8f1ABtBycO1+ttybHzA0Tt48kINipmGx4IkaVOmRQS96znnijg4R3WVrmAvKp0wiItywxh6ztkFRqU/7PmWVqD/e0NT/odkNAhkpvf7zJlpXQqV+ctS9BQ=
  file: finegraphics-*.zip
  on:
    tags: false
    repo: matusnovak/finegraphics
    branch: master
